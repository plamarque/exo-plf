<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
 
    Copyright (C) 2009 eXo Platform SAS.
    
    This is free software; you can redistribute it and/or modify it
    under the terms of the GNU Lesser General Public License as
    published by the Free Software Foundation; either version 2.1 of
    the License, or (at your option) any later version.
    
    This software is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
    Lesser General Public License for more details.
    
    You should have received a copy of the GNU Lesser General Public
    License along with this software; if not, write to the Free
    Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
-->
 
<configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.exoplaform.org/xml/ns/kernel_1_1.xsd http://www.exoplaform.org/xml/ns/kernel_1_1.xsd"
  xmlns="http://www.exoplaform.org/xml/ns/kernel_1_1.xsd">

  <!-- patched WebDAV -->
  <component>
    <key>org.exoplatform.services.jcr.webdav.WebDavServiceImpl</key>
    <type>org.exoplatform.services.cms.webdav.WebDavServiceImpl</type>
    <init-params>
      <value-param>
        <name>auto-mix-lockable</name>
        <value>false</value>
      </value-param>

      <value-param>
        <name>def-folder-node-type</name>
        <value>nt:folder</value>
      </value-param>

      <value-param>
        <name>def-file-node-type</name>
        <value>nt:file</value>
      </value-param>

      <value-param>
        <name>def-file-mimetype</name>
        <value>text/plain</value>
      </value-param>

      <value-param>
        <name>folder-icon-path</name>
        <value>/ecmexplorer/skin/icons/16x16/NodeTypes/DefaultSkin/nt-folder.gif</value>
      </value-param>

      <value-param>
        <name>update-policy</name>
        <value>create-version</value>
        <!--value>replace</value -->
        <!-- value>add</value -->
      </value-param>
    </init-params>
  </component>

  <!-- TenantCreationService -->
  <component>
    <key>org.exoplatform.cloudmanagement.multitenancy.PluggableTenantCreationService</key>
    <type>org.exoplatform.cloudmanagement.multitenancy.PluggableTenantCreationService</type>
    <init-params>
      <value-param>
        <name>max-tenants-num</name>
        <value>100</value>
      </value-param>
    </init-params>
  </component>

  <!-- Plugins for TenantCreationService START -->
  <component>
    <type>org.exoplatform.cloudmanagement.multitenancy.CreateNewRepositoryPlugin</type>
    <description>Create database</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>10</value>
      </value-param>
      <value-param>
        <name>configuration-path</name>
        <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/platform-tenant-configuration-template.xml</value>
      </value-param>
    </init-params>
  </component>

  <component>
    <type>org.exoplatform.cloudmanagement.multitenancy.TenantRegistryPlugin</type>
    <description>Create database</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>40</value>
      </value-param>
      <value-param>
        <name>registry-repository</name>
        <!-- Name of repository where information about tenant's will be stored. Should be static. -->
        <value>${tenant.repository.name}</value>
      </value-param>
    </init-params>
  </component>

  <component>
    <type>org.exoplatform.cloudmanagement.multitenancy.ChangeRootPasswordPlugin</type>
    <description>Change root password</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>50</value>
      </value-param>
    </init-params>
  </component>

  <!-- Teanancy mailing plugin -->
  <component>
    <type>org.exoplatform.cloudmanagement.multitenancy.SendPasswordByMailPlugin</type>
    <description>Send password</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>60</value>
      </value-param>
      <value-param>
        <name>sender-email-adress</name>
        <value>exo.cloud.noreply@gmail.com</value>
      </value-param>
      <value-param>
        <name>mail-subject</name>
        <value>Your eXo Platform Cloud domain</value>
      </value-param>
    </init-params>
  </component>

  <!-- Support of SendPasswordByMailPlugin - use from PLF  -->
  <!--
    <component> 
      <key>org.exoplatform.services.mail.MailService</key>
      <type>org.exoplatform.services.mail.impl.MailServiceImpl</type> 
      <init-params> 
        <properties-param>
          <name>config</name>  
          <property name="mail.smtp.host" value="smtp.gmail.com"/> 
          <property name="mail.smtp.port" value="465"/> 
          <property name="mail.transport.protocol" value="smtp"/> 
          <property name="mail.smtp.auth" value="true"/> 
          <property name="mail.smtp.auth.username"  value="damonzaza@gmail.com"/> 
          <property name="mail.smtp.auth.password" value="9_chudo_1"/> 
          <property name="mail.smtp.socketFactory.class" value="javax.net.ssl.SSLSocketFactory" /> 
          <property name="mail.smtp.socketFactory.fallback" value="false" /> 
        </properties-param> 
      </init-params> 
    </component>
  -->

  <!-- TemplateResolver configuration -->
  <component>
    <key>org.exoplatform.cloudmanagement.multitenancy.TemplateResolver</key>
    <type>org.exoplatform.cloudmanagement.multitenancy.TemplateResolver</type>
    <init-params>
      <value-param>
        <name>temaplate-mail-invitation</name>
        <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/template-invitation-mail.html</value>
      </value-param>
      <value-param>
        <name>template-mail-confirmation</name>
        <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/template-confirmation-mail.html</value>
      </value-param>
      <value-param>
        <name>template-mail-registration</name>
        <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/template-registration-mail.html</value>
      </value-param>
    </init-params>
  </component>

  <!-- Plugins for TenantCreationService END -->

  <!-- support of RepositoryCreationService -->
  <component>
    <type>org.exoplatform.cloudmanagement.groovy.TenancyGroovyScript2RestLoader</type>
    <init-params>
      <object-param>
        <name>observation.config</name>
        <object type="org.exoplatform.services.jcr.ext.script.groovy.ObservationListenerConfiguration">
          <field name="repository">
            <string>${tenant.repository.name}</string>
          </field>
          <field name="workspaces">
            <collection type="java.util.ArrayList">
              <value>
                <string>dev-monit</string>
              </value>
            </collection>
          </field>
        </object>
      </object-param>
    </init-params>
  </component>

  <!-- TenantRegistryPlugin support -->
  <component>
    <type>org.exoplatform.cloudmanagement.rest.TenancyRESTRegistryService</type>
  </component>

  <component>
    <type>org.exoplatform.services.jcr.ext.registry.RegistryService</type>
    <init-params>
      <properties-param>
        <name>locations</name>
      </properties-param>
    </init-params>
  </component>

  <component>
    <type>org.exoplatform.services.jcr.ext.repository.RestRepositoryService</type>
  </component>

  <!-- JCR components START -->
  <!-- Protect repository service method from direct call with TenantRepositoryService wrapper -->
  <component>
    <key>org.exoplatform.services.jcr.RepositoryService</key>
    <type>org.exoplatform.cloudmanagement.multitenancy.TenantRepositoryService</type>
    <component-plugins>
      <component-plugin>
        <name>add.namespaces</name>
        <set-method>addPlugin</set-method>
        <type>org.exoplatform.services.jcr.impl.AddNamespacesPlugin</type>
        <init-params>
          <properties-param>
            <name>namespaces</name>
            <property name="dc" value="http://purl.org/dc/elements/1.1/" />
            <!-- http://www.exoplatform.com/jcr-services/organization-service/1.0/ -->
            <property name="jos" value="http://www.exoplatform.com/jcr-services/organization-service/1.0/" />
            <property name="exoide" value="http://exoplatform.org/ide/1.1.x/" />
          </properties-param>
        </init-params>
      </component-plugin>
      <component-plugin>
        <name>add.nodeType</name>
        <set-method>addPlugin</set-method>
        <type>org.exoplatform.services.jcr.impl.AddNodeTypePlugin</type>
        <init-params>
          <values-param>
            <name>autoCreatedInNewRepository</name>
            <description>Node types configuration file</description>
            <value>jar:/conf/organization-nodetypes.xml</value>
          </values-param>
        </init-params>
      </component-plugin>
    </component-plugins>
  </component>

  <!-- JCR Dependencies -->
  <component>
    <key>org.exoplatform.services.jcr.ext.repository.creation.RepositoryCreationService</key>
    <type>org.exoplatform.services.jcr.ext.repository.creation.RepositoryCreationServiceImpl</type>
  </component>

  <!-- JCR Dependencies END -->
  <!-- HSQL Configuration -->
  <component>
    <key>org.exoplatform.services.database.creator.DBCreator</key>
    <type>org.exoplatform.services.database.creator.DBCreator</type>
    <init-params>
      <properties-param>
        <name>db-connection</name>
        <description>database connection properties</description>
        <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
        <property name="url" value="jdbc:hsqldb:file:${tenant.jcr.data.dir}/hsqldb" />
        <property name="username" value="sa" />
        <property name="password" value="" />
      </properties-param>
      <properties-param>
        <name>db-creation</name>
        <description>database creation properties</description>
        <property name="scriptPath" value="../${exo.conf.dir.name}/cloud/databases/hsqldb-schema.sql" />
        <property name="username" value="sa" />
        <property name="password" value="" />
      </properties-param>
    </init-params>
  </component>

  <!-- MySQL configuration -->
  <!--
    <component> 
      <key>org.exoplatform.services.database.creator.DBCreator</key>
      <type>org.exoplatform.services.database.creator.DBCreator</type> 
      <init-params> 
        <properties-param>
          <name>db-connection</name> 
          <description>database connection properties</description> 
          <property name="driverClassName" value="com.mysql.jdbc.Driver"/> 
          <property name="url" value="jdbc:mysql://localhost:3306/"/> 
          <property name="username" value="root"/> 
          <property name="password" value="root"/> 
          <property name="maxActive" value="100" /> 
          <property name="maxIdle" value="2" /> 
          <property name="initialSize" value="5" /> 
        </properties-param> 
        <properties-param> 
          <name>db-creation</name>
          <description>database creation properties</description> 
          <property name="scriptPath" value="../${exo.conf.dir.name}/cloud/databases/mysqldb-schema.sql"/> 
          <property name="username" value="root"/> 
          <property name="password" value="root"/> 
        </properties-param> 
      </init-params> 
    </component>
  -->

  <!-- Backup service -->
  <component>
    <key>org.exoplatform.services.jcr.ext.backup.BackupManager</key>
    <type>org.exoplatform.services.jcr.ext.backup.impl.BackupManagerImpl
      </type>
    <init-params>
      <properties-param>
        <name>backup-properties</name>
        <property name="default-incremental-job-period" value="3600" />
        <!--
          set default incremental periond = 60 minutes
        -->
        <property name="full-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.rdbms.FullBackupJob" />
        <property name="incremental-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.fs.IncrementalBackupJob" />
        <property name="backup-dir" value="${gatein.data.dir}/backup" />
        <property name="backup-dir" value="${exo.backup.dir}/backup${container.name.suffix}" />
      </properties-param>
    </init-params>
  </component>

  <!-- REST service for BackupManager -->
  <component>
    <type>org.exoplatform.services.jcr.ext.backup.server.HTTPBackupAgent</type>
  </component>

  <!-- JCR Organiation service -->
  <!--
    <component> 
      <key>org.exoplatform.services.organization.OrganizationService</key>
      <type>org.exoplatform.services.jcr.ext.organization.JCROrganizationServiceImpl</type> 
      <init-params>
        <value-param> 
          <name>storage-workspace</name> 
          <description>Workspace in default repository where organization storage will be created</description> 
          <value>portal-system</value> 
        </value-param>
      </init-params> 
    </component>
  -->

  <!-- JNDI -->
  <component>
    <key>org.exoplatform.services.naming.InitialContextInitializer</key>
    <type>org.exoplatform.services.naming.InitialContextInitializer</type>
    <init-params>
      <value-param>
        <name>bindings-store-path</name>
        <value>${gatein.data.dir}/jndi-bind-references.xml</value>
      </value-param>
    </init-params>
  </component>

  <!-- HSQL Configuration -->
  <external-component-plugins>
    <target-component>org.exoplatform.services.naming.InitialContextInitializer</target-component>
    <component-plugin>
      <name>bind.datasource</name>
      <set-method>addPlugin</set-method>
      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
      <init-params>
        <value-param>
          <name>bind-name</name>
          <value>${tenant.repository.name}</value>
        </value-param>
        <value-param>
          <name>class-name</name>
          <value>javax.sql.DataSource</value>
        </value-param>
        <value-param>
          <name>factory</name>
          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
        </value-param>
        <properties-param>
          <name>ref-addresses</name>
          <description>ref-addresses</description>
          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
          <property name="url" value="jdbc:hsqldb:file:${tenant.jcr.data.dir}/hsqldb/${tenant.repository.name}" />
          <property name="username" value="sa" />
          <property name="password" value="" />
        </properties-param>
      </init-params>
    </component-plugin>
    <component-plugin>
      <name>bind.datasource</name>
      <set-method>addPlugin</set-method>
      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
      <init-params>
        <value-param>
          <name>bind-name</name>
          <value>exo-idm_portal</value>
        </value-param>
        <value-param>
          <name>class-name</name>
          <value>javax.sql.DataSource</value>
        </value-param>
        <value-param>
          <name>factory</name>
          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
        </value-param>
        <properties-param>
          <name>ref-addresses</name>
          <description>ref-addresses</description>
          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
          <property name="url" value="jdbc:hsqldb:file:${tenant.jcr.data.dir}/../idm/exo_idm_portal" />
          <property name="username" value="sa" />
          <property name="password" value="" />
        </properties-param>
      </init-params>
    </component-plugin>
  </external-component-plugins>

  <!-- MySQL Configuration -->
  <!--
    <external-component-plugins>
      <target-component>org.exoplatform.services.naming.InitialContextInitializer</target-component>
      <component-plugin> 
        <name>bind.datasource</name> 
        <set-method>addPlugin</set-method>
       <type>org.exoplatform.services.naming.BindReferencePlugin</type> 
       <init-params> 
         <value-param>
           <name>bind-name</name> 
           <value>${tenant.repository.name}</value> 
         </value-param> 
         <value-param>
           <name>class-name</name> 
           <value>javax.sql.DataSource</value> 
         </value-param> 
         <value-param>
            <name>factory</name> 
            <value>org.apache.commons.dbcp.BasicDataSourceFactory</value> 
         </value-param>
         <properties-param> 
           <name>ref-addresses</name> 
           <description>ref-addresses</description> 
           <property name="driverClassName" value="com.mysql.jdbc.Driver"/> 
           <property name="url" value="jdbc:mysql://localhost:3306/${tenant.repository.name}"/> 
           <property name="username" value="root"/>
           <property name="password" value="root"/> 
           <property name="maxActive" value="100" /> 
           <property name="maxIdle" value="2" /> 
           <property name="initialSize" value="5" /> 
         </properties-param> 
       </init-params>
     </component-plugin> 
     <component-plugin> 
       <name>bind.datasource</name> 
       <set-method>addPlugin</set-method>
      <type>org.exoplatform.services.naming.BindReferencePlugin</type> 
      <init-params> 
        <value-param>
          <name>bind-name</name> 
          <value>exo-idm_portal</value> 
        </value-param> 
        <value-param> 
          <name>class-name</name>
           <value>javax.sql.DataSource</value> 
        </value-param> 
        <value-param> 
          <name>factory</name>
          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value> 
        </value-param> 
        <properties-param>
          <name>ref-addresses</name> 
          <description>ref-addresses</description> 
          <property name="driverClassName" value="com.mysql.jdbc.Driver"/> 
          <property name="url" value="jdbc:mysql://localhost:3306/exo_idm_portal"/>
          <property name="username" value="root"/> 
          <property name="password" value="root"/> 
          <property name="maxActive" value="100" /> 
          <property name="maxIdle" value="2" /> 
          <property name="initialSize" value="5" /> 
        </properties-param> 
      </init-params> 
    </component-plugin> 
  </external-component-plugins>
  -->

</configuration>
