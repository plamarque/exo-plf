<?xml version="1.0"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>org.exoplatform</groupId>
    <artifactId>exo.platform.testsuite.perf.qaf</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <packaging>pom</packaging>
    <name>Automated Test Runner and Performance Reports for PLF on QAF</name>
    <description>Automated Test Runner and Performance Reports for PLF on QAF</description>

    <parent>
        <groupId>org.exoplatform</groupId>
        <artifactId>exo.parent</artifactId>
        <version>8.1</version>
    </parent>

    <properties>
        <!-- JMeter scenario file (shouldn't be overrided from the outside) -->
        <jmeter-version>2.4</jmeter-version>
        <jmeter-plugins-version>0.3.0</jmeter-plugins-version>
        <jmeter.home>${project.build.directory}/jakarta-jmeter-${jmeter-version}</jmeter.home>
        <history.directory>${project.build.directory}/history/${project.version}-${java.specification.version}-${dataset.version}</history.directory>
        <test-host>localhost</test-host>
        <test-port>8080</test-port>
        <test-duration>3600</test-duration>
        <test-loop-count>100000000</test-loop-count>
        <test-org-or-admin>administration</test-org-or-admin>
        <test-rampup>0</test-rampup>
        <test-report-file-prefix>${basedir}/target/${scenario.file.name}-${__time(MMddHHmm)}</test-report-file-prefix>
        <test-connect-timeout>150000</test-connect-timeout>
        <test-response-timeout>500000</test-response-timeout>
        <test-think-time>3000</test-think-time>
        <test-max-userid>9</test-max-userid>
        <test-userid-prefix>bench.user</test-userid-prefix>
        <test-user-password>exo</test-user-password>
        <test-use-demo-account>true</test-use-demo-account>
        <test-threadcount>1</test-threadcount>
    </properties>

  <profiles>

        <!--  Use WARMUP to pre-heat Performance Testings -->
        <profile>
            <id>WARMUP</id>
            <properties>
                <test-duration>300</test-duration>
                <scenario.file.name>PLF_PERF_04_SocialRead-3.0.x.jmx</scenario.file.name>
            </properties>
        </profile>

    <!--
            The Reference of Platform Performance

            http://wiki-int.exoplatform.org/display/PLF/Platform+Tests+Performance

            http://wiki-int.exoplatform.org/display/PLF/Test+Requirement+PLF_PERF_01_AllScenarios
            http://wiki-int.exoplatform.org/display/PLF/Test+Requirement+PLF_PERF_02_Social
            http://wiki-int.exoplatform.org/display/PLF/Test+Requirement+PERF_PLF_03_EcmsBasicRun
            http://wiki-int.exoplatform.org/display/PLF/Test+Requirement+PLF_PERF_04_SocialRead
            http://wiki-int.exoplatform.org/display/PLF/Test+Requirement+PLF_PERF_05_Login

     -->
    <profile>
        <id>PLF_PERF_01_AllScenarios-3.0.x-simplified</id>
        <properties>
            <scenario.file.name>PLF_PERF_01_AllScenarios-3.0.x-simplified.jmx</scenario.file.name>
        </properties>
    </profile>
    <profile>
        <id>PLF_PERF_02_Social-3.0.x-simplified</id>
        <properties>
            <scenario.file.name>PLF_PERF_02_Social-3.0.x-simplified.jmx</scenario.file.name>
        </properties>
    </profile>
    <profile>
        <id>PLF_PERF_03_ECMS-Public</id>
        <properties>
            <scenario.file.name>PLF_PERF_03_ECMS-Public.jmx</scenario.file.name>
        </properties>
    </profile>
    <profile>
        <id>PLF_PERF_04_SocialRead-3.0.x</id>
        <properties>
            <scenario.file.name>PLF_PERF_04_SocialRead-3.0.x.jmx</scenario.file.name>
        </properties>
    </profile>
    <profile>
        <id>PLF_PERF_05_Login</id>
        <properties>
            <scenario.file.name>PLF_PERF_05_Login.jmx</scenario.file.name>
        </properties>
    </profile>
  </profiles>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <version>2.1</version>
                <executions>
                    <execution>
                        <id>unpack-jmeter</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>org.apache.jmeter</groupId>
                                    <artifactId>jmeter</artifactId>
                                    <version>${jmeter-version}</version>
                                    <type>zip</type>
                                </artifactItem>
                            </artifactItems>
                            <outputDirectory>${project.build.directory}</outputDirectory>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-jmeter-plugin</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>org.apache.jmeter</groupId>
                                    <artifactId>jmeter-plugins</artifactId>
                                    <version>${jmeter-plugins-version}</version>
                                    <type>zip</type>
                                </artifactItem>
                            </artifactItems>
                            <outputDirectory>${project.build.directory}/jakarta-jmeter-${jmeter-version}/lib/ext/</outputDirectory>
                            <includes>JMeterPlugins.jar</includes>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-jmeter-plugin-agents</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>org.apache.jmeter</groupId>
                                    <artifactId>jmeter-plugins</artifactId>
                                    <version>${jmeter-plugins-version}</version>
                                    <type>zip</type>
                                </artifactItem>
                            </artifactItems>
                            <outputDirectory>${project.build.directory}/jakarta-jmeter-${jmeter-version}/bin</outputDirectory>
                            <includes>serverAgent/*.*</includes>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <version>1.1</version>
                <executions>
                    <execution>
                        <id>overide-jmeterproperties001</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <executable>mv</executable>
                            <workingDirectory>${basedir}</workingDirectory>
                            <arguments>
                                <argument>${project.build.directory}/jakarta-jmeter-${jmeter-version}/bin/jmeter.properties</argument>
                                <argument>${project.build.directory}/jakarta-jmeter-${jmeter-version}/bin/jmeter.properties_</argument>
                            </arguments>
                        </configuration>
                    </execution>
                    <execution>
                        <id>overide-jmeterproperties002</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <executable>cp</executable>
                            <workingDirectory>${basedir}</workingDirectory>
                            <arguments>
                                <argument>${basedir}/src/test/jmeter/jmeter.properties</argument>
                                <argument>${project.build.directory}/jakarta-jmeter-${jmeter-version}/bin/jmeter.properties</argument>
                            </arguments>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>chronos-maven-plugin</artifactId>
                <version>1.0-SNAPSHOT</version>
                <configuration>
                    <jmeterhome>${jmeter.home}</jmeterhome>
                    <historydir>${history.directory}</historydir>
                    <options>
                        <value>-XX:+UseParallelGC</value>
                        <value>-XX:+UseParallelOldGC</value>
                    </options>
                    <heap>756m</heap>
                    <newsize>256m</newsize>
                    <permsize>192m</permsize>
                    <survivorratio>8</survivorratio>
                </configuration>
                <executions>
                    <execution>
                        <id>${scenario.file.name}-${test-threadcount}-test</id>
                        <configuration>
                            <dataid>${scenario.file.name}-${test-threadcount}-</dataid>
                            <input>${basedir}/src/test/jmeter/${scenario.file.name}</input>
                            <sysproperties>
                                <property>
                                    <name>expThreadCount</name>
                                    <value>${test-threadcount}</value>
                                </property>
                                <property>
                                    <name>expDuration</name>
                                    <value>${test-duration}</value>
                                </property>
                                <property>
                                    <name>expHost</name>
                                    <value>${test-host}</value>
                                </property>
                                <property>
                                    <name>expLoopCount</name>
                                    <value>${test-loop-count}</value>
                                </property>
                                <property>
                                    <name>expPort</name>
                                    <value>${test-port}</value>
                                </property>
                                <property>
                                    <name>expOrgOrAdmin</name>
                                    <value>${test-org-or-admin}</value>
                                </property>
                                <property>
                                    <name>expReportFilePrefix</name>
                                    <value>${test-report-file-prefix}</value>
                                </property>
                                <property>
                                    <name>expResponseTimeOut</name>
                                    <value>${test-response-timeout}</value>
                                </property>
                                <property>
                                    <name>expThinkTime</name>
                                    <value>${test-think-time}</value>
                                </property>
                                <property>
                                    <name>expConnectTimeOut</name>
                                    <value>${test-connect-timeout}</value>
                                </property>
                                <property>
                                    <name>expMaxUserId</name>
                                    <value>${test-max-userid}</value>
                                </property>
                                <property>
                                    <name>expUserIdPrefix</name>
                                    <value>${test-userid-prefix}</value>
                                </property>
                                <property>
                                    <name>expUserPassword</name>
                                    <value>${test-user-password}</value>
                                </property>
                                <property>
                                    <name>expUseDemoAccount</name>
                                    <value>${test-use-demo-account}</value>
                                </property>
                            </sysproperties>
                        </configuration>
                        <goals>
                            <goal>jmeter</goal>
                            <goal>check</goal>
                            <goal>savehistory</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

  <reporting>
    <plugins>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>chronos-maven-plugin</artifactId>
        <version>1.0-SNAPSHOT</version>
        <configuration>
          <historydir>${history.directory}</historydir>
        </configuration>
        <reportSets>
          <reportSet>
            <id>${scenario.file.name}-${test-threadcount}-report</id>
            <configuration>
              <dataid>${scenario.file.name}-${test-threadcount}</dataid>
              <reportid>jmeter-${scenario.file.name}-${test-threadcount}-report</reportid>
              <title>${scenario.file.name}-${test-threadcount} concurrents users Test Report</title>
              <description>${scenario.file.name}-${test-threadcount} concurrents users Test Report</description>
            </configuration>
            <reports>
              <report>report</report>
              <report>historyreport</report>
            </reports>
          </reportSet>
        </reportSets>
      </plugin>
    </plugins>
  </reporting>
</project>
